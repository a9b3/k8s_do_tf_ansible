# vim: set ft=sh:
# requires
# /etc/kubernetes/certs dir
# - ca.pem
# - ca-key.pem
#
# outputs
# - kubernetes.crt
# - kubernetes.key

{% set current=hostvars[inventory_hostname] %}

dest=/etc/kubernetes/certs
certfilename=kubernetes.crt
keyfilename=kubernetes.key

echo '[ req ]
distinguished_name = req_distinguished_name
req_extensions = v3_req

[ req_distinguished_name ]
countryName = US
stateOrProvinceName = CA
localityName = Sunnyvale
0.organizationName = Sam
organizationalUnitName = Sam
commonName = Sam

[ v3_req ]
basicConstraints = CA:FALSE
keyUsage = nonRepudiation, digitalSignature, keyEncipherment
subjectAltName = @alt_names

[ alt_names ]
DNS.1 = {{current["name"]}}
DNS.2 = {{current["name"]}}.local
IP.1 = 127.0.0.1
IP.2 = {{current["ipv4_address_private"]}}
IP.3 = {{current["ipv4_address"]}}' > $dest/openssl.cnf

# generate private key and csr
openssl req \
  -out $dest/csr \
  -new -newkey rsa:2048 \
  -nodes \
  -keyout $dest/$keyfilename \
  -subj '/CN=kubernetes' \
  -config $dest/openssl.cnf

openssl x509 \
  -req \
  -in $dest/csr \
  -CA $dest/ca.pem \
  -CAkey $dest/ca-key.pem \
  -CAcreateserial \
  -days 365 \
  -extensions v3_req \
  -extfile $dest/openssl.cnf \
  -out $dest/$certfilename
