# vim: set ft=sh:
# requires
# {{optdest}} dir
# - ca.pem
# - ca-key.pem
#
# outputs
# - {{certfilename}}
# - {{keyfilename}}

{% set current=hostvars[inventory_hostname] %}

echo '[ req ]
distinguished_name = req_distinguished_name
req_extensions = v3_req

[ req_distinguished_name ]
countryName = US
stateOrProvinceName = CA
localityName = Sunnyvale
0.organizationName = Sam
organizationalUnitName = Sam
commonName = Sam

[ v3_req ]
basicConstraints = CA:FALSE
keyUsage = nonRepudiation, digitalSignature, keyEncipherment
subjectAltName = @alt_names

[ alt_names ]
DNS.1 = {{current["name"]}}
DNS.2 = {{current["name"]}}.local
IP.1 = 127.0.0.1
IP.2 = {{current["ipv4_address_private"]}}
IP.3 = {{current["ipv4_address"]}}' > {{optdest}}/certs/openssl.cnf

# generate private key and csr
openssl req \
  -out {{optdest}}/certs/csr \
  -new -newkey rsa:2048 \
  -nodes \
  -keyout {{optdest}}/certs/{{keyfilename}} \
  -subj '/CN=kubernetes' \
  -config {{optdest}}/certs/openssl.cnf

openssl x509 \
  -req \
  -in {{optdest}}/certs/csr \
  -CA {{optdest}}/certs/ca.pem \
  -CAkey {{optdest}}/certs/ca-key.pem \
  -CAcreateserial \
  -days 365 \
  -extensions v3_req \
  -extfile {{optdest}}/certs/openssl.cnf \
  -out {{optdest}}/certs/{{certfilename}}
