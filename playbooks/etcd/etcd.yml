---
- hosts: etcd
  # serial: '50%'
  become: true
  gather_facts: False
  vars:
    etcd_version: 'v3.0.10'

  handlers:
    - name: reload etcd
      command: "{{ item }}"
      with_items:
        - systemctl daemon-reload
        - systemctl restart etcd

  tasks:
    - name: install python 2
      raw: test -e /usr/bin/python || (apt -y update && apt install -y python-minimal)

    ##########################################################################
    # certs
    ##########################################################################
    - name: register certs_already_setup
      register: certs_already_setup
      stat: path=/etc/etcd/certs
    - name: directory /etc/etcd/certs
      file: path=/etc/etcd/certs state=directory
      # when: certs_already_setup|failed
    - name: copy ca.pem
      copy: src=../../certs/ca.pem dest=/etc/etcd/certs/ca.pem
      # when: certs_already_setup|failed
    - name: copy ca-key.pem
      copy: src=../../certs/ca-key.pem dest=/etc/etcd/certs/ca-key.pem
      # when: certs_already_setup|failed
    - name: template generate_certs.sh
      template: src=./generate_certs.sh.j2
        dest=/etc/etcd/generate_certs.sh
        mode=0700
      # when: certs_already_setup|failed
    - name: execute generate_certs.sh
      shell: /etc/etcd/generate_certs.sh
      # when: certs_already_setup|failed

    ##########################################################################
    # etcd
    ##########################################################################
    - name: register etcd_installed
      register: etcd_installed
      command: etcdctl v
      ignore_errors: true
    - name: unarchive etcd binary
      unarchive:
        src="https://github.com/coreos/etcd/releases/download/{{etcd_version}}/etcd-{{etcd_version}}-linux-amd64.tar.gz"
        dest=/opt
        copy=no
      when: etcd_installed|failed
    - name: mv etcd binary to /usr/bin
      command: "{{ item }}"
      with_items:
        - mv /opt/etcd-{{etcd_version}}-linux-amd64/etcd /usr/bin
        - mv /opt/etcd-{{etcd_version}}-linux-amd64/etcdctl /usr/bin
      when: etcd_installed|failed
    - name: set ETCDCTL_API=3 in environment
      lineinfile: dest=/etc/environment regexp=^ETCDCTL_API line=ETCDCTL_API=3
      when: etcd_installed|failed
    - name: directory /var/lib/etcd
      file: path=/var/lib/etcd state=directory
    - name: template etcd.service
      template: src=./etcd.service.j2
        dest=/etc/systemd/system/etcd.service
        mode=0644
      notify:
        - reload etcd
    - name: start etcd.service
      service: name=etcd state=started
