{% set ips=[] %}
{% for host in groups['etcd'] %}
  {% set to_concat = ['https://', hostvars[host]['ipv4_address_private'], ':2379'] %}
  {% set str = to_concat|join('') %}
  {% if ips.insert(loop.index, str) %}
  {% endif %}
{% endfor %}

{% set current=hostvars[inventory_hostname] %}

[Unit]
Description=Flannel
Documentation=https://github.com/coreos/flannel

[Service]
ExecStart=/usr/bin/flanneld \
  --etcd-endpoints={{ips|join(',')}} \
  --etcd-keyfile={{ optdest }}/certs/{{ keyfilename }} \
  --etcd-certfile={{ optdest }}/certs/{{ certfilename }} \
  --etcd-cafile={{ optdest }}/certs/ca.pem \
  --iface={{current['ipv4_address']}} \
  --ip-masq=true
ExecStartPost=-/bin/bash -c "until [ -e /run/flannel/subnet.env ]; do echo \"waiting for write.\"; sleep 3; done "
TimeoutSec=infinity
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
