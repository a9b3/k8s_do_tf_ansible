---
- hosts: kube-controller
  # serial: '50%'
  become: true
  gather_facts: False
  vars:
    kubernetes_version: 'v1.4.0'
    kubernetes_cluster_cidr: '10.200.0.0/16'
    etcd_version: 'v3.0.10'
    optdest: '/etc/kubernetes'
    certfilename: 'kubernetes.crt'
    keyfilename: 'kubernetes.key'

  tasks:
    - name: install python 2
      raw: test -e /usr/bin/python || (apt -y update && apt install -y python-minimal)

    - include: ./tasks/certs.yml

    - include: ./tasks/set-cluster-cidr.yml

    - name: copy token.csv
      copy: src=./auth/token.csv dest=/etc/kubernetes/certs/

    - name: copy authorization-policy.jsonl
      copy: src=./auth/authorization-policy.jsonl dest=/etc/kubernetes/certs/

    - name: download kubectl
      get_url:
        url: https://storage.googleapis.com/kubernetes-release/release/{{kubernetes_version}}/bin/linux/amd64/kubectl
        dest: /usr/bin/kubectl
        mode: 0700

    ##########################################################################
    # kube-apiserver
    ##########################################################################

    - name: download kube-apiserver
      get_url:
        url: https://storage.googleapis.com/kubernetes-release/release/{{kubernetes_version}}/bin/linux/amd64/kube-apiserver
        dest: /usr/bin/kube-apiserver
        mode: 0700

    - name: template kube-apiserver.service
      template:
        src: ./services/kube-apiserver.service.j2
        dest: /etc/systemd/system/kube-apiserver.service
        mode: 0644
      notify:
        - reload kube-apiserver

    - name: start kube-apiserver service
      service:
        name: kube-apiserver
        state: started

    ##########################################################################
    # kube-controller-manager
    ##########################################################################

    - name: download kube-controller-manager
      get_url:
        url: https://storage.googleapis.com/kubernetes-release/release/{{kubernetes_version}}/bin/linux/amd64/kube-controller-manager
        dest: /usr/bin/kube-controller-manager
        mode: 0700

    - name: template kube-controller-manager.service
      template:
        src: ./services/kube-controller-manager.service.j2
        dest: /etc/systemd/system/kube-controller-manager.service
        mode: 0644
      notify:
        - reload kube-controller-manager

    - name: start kube-controller-manager service
      service:
        name: kube-controller-manager
        state: started

    ##########################################################################
    # kube-scheduler
    ##########################################################################

    - name: download kube-scheduler
      get_url:
        url: https://storage.googleapis.com/kubernetes-release/release/{{kubernetes_version}}/bin/linux/amd64/kube-scheduler
        dest: /usr/bin/kube-scheduler
        mode: 0700

    - name: template kube-scheduler.service
      template:
        src: ./services/kube-scheduler.service.j2
        dest: /etc/systemd/system/kube-scheduler.service
        mode: 0644
      notify:
        - reload kube-scheduler

    - name: start kube-scheduler service
      service:
        name: kube-scheduler
        state: started

  handlers:
    - include: ./handlers/handlers.yml
