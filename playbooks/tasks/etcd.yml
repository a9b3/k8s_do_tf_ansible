---
- name: register variable etcd_installed
  register: etcd_installed
  command: etcd --version
  ignore_errors: true

- name: download etcd binary
  unarchive:
    src: "https://github.com/coreos/etcd/releases/download/{{ etcd_version }}/etcd-{{ etcd_version }}-linux-amd64.tar.gz"
    dest: /opt
    copy: no
  when: etcd_installed|failed

- name: move etcd binary to /usr/bin
  command: "{{ item }}"
  with_items:
    - mv /opt/etcd-{{ etcd_version }}-linux-amd64/etcd /usr/bin
    - mv /opt/etcd-{{ etcd_version }}-linux-amd64/etcdctl /usr/bin
  notify:
    - reload etcd
  when: etcd_installed|failed

- name: make sure directory /var/lib/etcd exists
  file: path=/var/lib/etcd state=directory

- name: move template etcd.service
  template:
    src: ./services/etcd.service.j2
    dest: /etc/systemd/system/etcd.service
    mode: 0644
  notify:
    - reload etcd

- name: set ETCDCTL_API=2 in /etc/environment
  lineinfile: dest=/etc/environment regexp=^ETCDCTL_API line=ETCDCTL_API=2

# Allows etcdctl to work without passing in --ca-file --cert-file --key-file
- name: set ETCDCTL_CA_FILE in /etc/environment
  lineinfile: dest=/etc/environment regexp=^ETCDCTL_CA_FILE line=ETCDCTL_CA_FILE={{ optdest }}/certs/ca.pem

- name: set ETCDCTL_CERT_FILE in /etc/environment
  lineinfile: dest=/etc/environment regexp=^ETCDCTL_CERT_FILE line=ETCDCTL_CERT_FILE={{ optdest }}/certs/{{ certfilename }}

- name: set ETCDCTL_KEY_FILE in /etc/environment
  lineinfile: dest=/etc/environment regexp=^ETCDCTL_KEY_FILE line=ETCDCTL_KEY_FILE={{ optdest }}/certs/{{ keyfilename }}
